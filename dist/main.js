"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e=require("atom"),t=require("log4js"),r=require("assert"),n=require("rxjs-compat/bundles/rxjs-compat.umd.min.js"),o=require("path"),i=require("os");function s(e){return e&&"object"==typeof e&&"default"in e?e:{default:e}}var a=s(e),u=s(t),l=s(r),c=s(n),f=s(o),d=s(i);var p={};Object.defineProperty(p,"__esModule",{value:!0});var h=p.ProviderRegistry=void 0;const m=a.default;h=p.ProviderRegistry=class{constructor(){this.providers=[]}addProvider(e){const t=this.providers.findIndex((t=>e.priority>t.priority));return-1===t?this.providers.push(e):this.providers.splice(t,0,e),new m.Disposable((()=>{this.removeProvider(e)}))}removeProvider(e){const t=this.providers.indexOf(e);-1!==t&&this.providers.splice(t,1)}getProviderForEditor(e){const t=e.getGrammar().scopeName;return this.findProvider(t)}getAllProvidersForEditor(e){const t=e.getGrammar().scopeName;return this.findAllProviders(t)}findProvider(e){for(const t of this.findAllProviders(e))return t;return null}*findAllProviders(e){for(const t of this.providers)null!=t.grammarScopes&&-1===t.grammarScopes.indexOf(e)||(yield t)}};var g={},v={},y={},_={};Object.defineProperty(_,"__esModule",{value:!0}),_.default=void 0;class w{constructor(...e){this.disposed=void 0,this.teardowns=void 0,this.teardowns=new Set,this.disposed=!1,e.length&&this.add(...e)}add(...e){if(this.disposed)throw new Error("Cannot add to an already disposed UniversalDisposable!");for(let t=0;t<e.length;t++)b(e[t]),this.teardowns.add(e[t])}addUntilDestroyed(e,...t){if(this.disposed)throw new Error("Cannot add to an already disposed UniversalDisposable!");const r=new w(...t,e.onDidDestroy((()=>{r.dispose(),this.remove(r)})));this.add(r)}remove(e){this.disposed||this.teardowns.delete(e)}dispose(){this.disposed||(this.disposed=!0,this.teardowns.forEach((e=>{"function"==typeof e.dispose?e.dispose():"function"==typeof e.unsubscribe?e.unsubscribe():"function"==typeof e.destroy?e.destroy():"function"==typeof e&&e()})),this.teardowns=null)}unsubscribe(){this.dispose()}clear(){this.disposed||this.teardowns.clear()}}function b(e){if("function"!=typeof e.dispose&&"function"!=typeof e.unsubscribe&&"function"!=typeof e.destroy&&"function"!=typeof e)throw new TypeError("Arguments to UniversalDisposable.add must be disposable")}_.default=w,Object.defineProperty(y,"__esModule",{value:!0}),y.attachEvent=function(e,t,r){return e.addListener(t,r),new x.default((()=>{e.removeListener(t,r)}))},y.observableFromSubscribeFunction=function(e){return E.Observable.create((t=>new x.default(e(t.next.bind(t)))))};var P,x=(P=_)&&P.__esModule?P:{default:P},E=c.default;Object.defineProperty(v,"__esModule",{value:!0}),v.existingEditorForUri=function(e){for(const t of atom.workspace.getTextEditors())if(t.getPath()===e)return t;return null},v.existingEditorForBuffer=function(e){for(const t of atom.workspace.getTextEditors())if(t.getBuffer()===e)return t;return null},v.getViewOfEditor=R,v.getScrollTop=function(e){return R(e).getScrollTop()},v.setScrollTop=A,v.setPositionAndScroll=function(e,t,r){e.setCursorBufferPosition(t,{autoscroll:!1}),A(e,r)},v.getCursorPositions=function(e){return O.Observable.defer((()=>{const t=e.getCursors()[0];return(0,T.default)(null!=t),O.Observable.merge(O.Observable.of(t.getBufferPosition()),(0,C.observableFromSubscribeFunction)(t.onDidChangePosition.bind(t)).map((e=>e.newBufferPosition)))}))},v.observeEditorDestroy=function(e){return(0,C.observableFromSubscribeFunction)(e.onDidDestroy.bind(e)).map((t=>e)).take(1)},v.enforceReadOnlyEditor=function(e,t=["append","setText"]){return e.getElement().setAttribute("readonly",""),{dispose(){e.getElement().removeAttribute("readonly")}}},v.enforceSoftWrap=function(e,t){return e.setSoftWrapped(t),e.onDidChangeSoftWrapped((r=>{r!==t&&process.nextTick((()=>{e.isDestroyed()||e.setSoftWrapped(t)}))}))},v.isValidTextEditor=function(e){return e instanceof S.TextEditor},v.centerScrollToBufferLine=function(e,t){const r=e.getModel(),n=e.pixelPositionForBufferPosition([t,0]).top+r.getLineHeightInPixels()/2-e.clientHeight/2;e.setScrollTop(Math.max(n,1)),e.focus(),r.setCursorBufferPosition([t,0],{autoscroll:!1})};var T=function(e){return e&&e.__esModule?e:{default:e}}(l.default),S=a.default,O=c.default,C=y;function R(e){return atom.views.getView(e)}function A(e,t){R(e).setScrollTop(t)}var U={};Object.defineProperty(U,"__esModule",{value:!0}),U.goToLocation=async function(e,t){var r,n,o;const i=null===(r=null==t?void 0:t.center)||void 0===r||r,s=null===(n=null==t?void 0:t.moveCursor)||void 0===n||n,a=null===(o=null==t?void 0:t.activatePane)||void 0===o||o,u=null==t?void 0:t.activateItem,l=null==t?void 0:t.line,c=null==t?void 0:t.column,f=null==t?void 0:t.pending,d=atom.workspace.getActiveTextEditor();if(null!=d&&d.getPath()===e){const e=atom.workspace.paneContainerForItem(d);return(0,j.default)(null!=e),a&&e.activate(),null!=l?L(d,{line:l,column:null==c?0:c,center:i,moveCursor:s}):(0,j.default)(null==c,"goToLocation: Cannot specify just column"),d}{const t=await atom.workspace.open(e,{initialLine:l,initialColumn:c,searchAllPanes:!0,activatePane:a,activateItem:u,pending:f});if(null==t){const t={};Error.captureStackTrace(t);const r=Error(`atom.workspace.open returned null on ${e}`);throw(0,$.getLogger)("goToLocation").error(r),r}return i&&null!=l&&t.scrollToBufferPosition([l,c],{center:!0}),t}},U.goToLocationInEditor=L,U.observeNavigatingEditors=function(){return F};var $=u.default,I=c.default,j=function(e){return e&&e.__esModule?e:{default:e}}(l.default);const F=new I.Subject;function L(e,t){const r=null==t.center||t.center,n=null==t.moveCursor||t.moveCursor,{line:o,column:i}=t;n&&e.setCursorBufferPosition([o,i]),r&&e.scrollToBufferPosition([o,i],{center:!0}),F.next(e)}Object.defineProperty(g,"__esModule",{value:!0}),g.applyTextEditsForMultipleFiles=async function(e){const t=Array.from(e.keys()),r=(await Promise.all(t.map((async e=>(0,M.goToLocation)(e))))).map((e=>{(0,D.default)(null!=e);const t=e.getBuffer();return[t,t.createCheckpoint()]})),n=t.reduce(((t,r)=>{const n=e.get(r);return t&&null!=n&&q(r,...n)}),!0);n||r.forEach((([e,t])=>(e.revertToCheckpoint(t),!1)));return n},g.applyTextEdits=q;var B=g.applyTextEditsToBuffer=function(e,t){return N(e,z(t))},D=function(e){return e&&e.__esModule?e:{default:e}}(l.default),k=u.default,W=v,M=U;function q(e,...t){const r=z(t),n=(0,W.existingEditorForUri)(e);return(0,D.default)(null!=n),N(n.getBuffer(),r)}function N(e,t){if(function(e){for(let t=0;t<e.length-1;t++)if(e[t].oldRange.end.isGreaterThan(e[t+1].oldRange.start))return!0;return!1}(t))return(0,k.getLogger)("text-edit").warn("applyTextEdits was called with overlapping edits."),!1;if(1===t.length&&t[0].oldRange.isEqual(e.getRange()))return(null==t[0].oldText||t[0].oldText===e.getText())&&(e.setTextViaDiff(t[0].newText),!0);const r=e.createCheckpoint();for(let n=t.length-1;n>=0;n--){if(!H(e,t[n]))return e.revertToCheckpoint(r),!1}return e.groupChangesSinceCheckpoint(r),!0}function H(e,t){if(t.oldRange.start.row===t.oldRange.end.row){const r=e.lineLengthForRow(t.oldRange.start.row);if(t.oldRange.end.column>r)return!1}if(null!=t.oldText){if(e.getTextInRange(t.oldRange)!==t.oldText)return!1}return e.setTextInRange(t.oldRange,t.newText),!0}function z(e){return e.map(((e,t)=>[e,t])).sort((([e,t],[r,n])=>e.oldRange.start.compare(r.oldRange.start)||e.oldRange.end.compare(r.oldRange.end)||t-n)).map((([e])=>e))}var V,G,J={},X={exports:{}};V=X,void 0!==(G=function(e,t){function r(e){return"%"+e.charCodeAt(0).toString(16).toUpperCase()}function n(e){return encodeURIComponent(e).replace(/[!'()*]/g,r)}function o(e){return e.replace(/[#?]/,r)}Object.defineProperty(t,"__esModule",{value:!0});var i,s=function(){function e(){this._scheme=e._empty,this._authority=e._empty,this._path=e._empty,this._query=e._empty,this._fragment=e._empty,this._formatted=null,this._fsPath=null}return e.isUri=function(t){return t instanceof e||!!t&&"string"==typeof t.authority&&"string"==typeof t.fragment&&"string"==typeof t.path&&"string"==typeof t.query&&"string"==typeof t.scheme},Object.defineProperty(e.prototype,"scheme",{get:function(){return this._scheme},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"authority",{get:function(){return this._authority},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"path",{get:function(){return this._path},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"query",{get:function(){return this._query},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fragment",{get:function(){return this._fragment},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"fsPath",{get:function(){var t;return this._fsPath||(t=this._authority&&this._path&&"file"===this.scheme?"//"+this._authority+this._path:e._driveLetterPath.test(this._path)?this._path[1].toLowerCase()+this._path.substr(2):this._path,i&&(t=t.replace(/\//g,"\\")),this._fsPath=t),this._fsPath},enumerable:!0,configurable:!0}),e.prototype.with=function(t){if(!t)return this;var r=t.scheme,n=t.authority,o=t.path,i=t.query,s=t.fragment;if(void 0===r?r=this.scheme:null===r&&(r=""),void 0===n?n=this.authority:null===n&&(n=""),void 0===o?o=this.path:null===o&&(o=""),void 0===i?i=this.query:null===i&&(i=""),void 0===s?s=this.fragment:null===s&&(s=""),r===this.scheme&&n===this.authority&&o===this.path&&i===this.query&&s===this.fragment)return this;var a=new e;return a._scheme=r,a._authority=n,a._path=o,a._query=i,a._fragment=s,e._validate(a),a},e.parse=function(t){var r=new e,n=e._parseComponents(t);return r._scheme=n.scheme,r._authority=decodeURIComponent(n.authority),r._path=decodeURIComponent(n.path),r._query=decodeURIComponent(n.query),r._fragment=decodeURIComponent(n.fragment),e._validate(r),r},e.file=function(t){var r=new e;if(r._scheme="file",i&&(t=t.replace(/\\/g,e._slash)),t[0]===e._slash&&t[0]===t[1]){var n=t.indexOf(e._slash,2);-1===n?r._authority=t.substring(2):(r._authority=t.substring(2,n),r._path=t.substring(n))}else r._path=t;return r._path[0]!==e._slash&&(r._path=e._slash+r._path),e._validate(r),r},e._parseComponents=function(t){var r={scheme:e._empty,authority:e._empty,path:e._empty,query:e._empty,fragment:e._empty},n=e._regexp.exec(t);return n&&(r.scheme=n[2]||r.scheme,r.authority=n[4]||r.authority,r.path=n[5]||r.path,r.query=n[7]||r.query,r.fragment=n[9]||r.fragment),r},e.from=function(t){return(new e).with(t)},e._validate=function(t){if(t.scheme&&!e._schemePattern.test(t.scheme))throw new Error("[UriError]: Scheme contains illegal characters.");if(t.path)if(t.authority){if(!e._singleSlashStart.test(t.path))throw new Error('[UriError]: If a URI contains an authority component, then the path component must either be empty or begin with a slash ("/") character')}else if(e._doubleSlashStart.test(t.path))throw new Error('[UriError]: If a URI does not contain an authority component, then the path cannot begin with two slash characters ("//")')},e.prototype.toString=function(t){return void 0===t&&(t=!1),t?e._asFormatted(this,!0):(this._formatted||(this._formatted=e._asFormatted(this,!1)),this._formatted)},e._asFormatted=function(t,r){var i=r?o:n,s=[],a=t.scheme,u=t.authority,l=t.path,c=t.query,f=t.fragment;if(a&&s.push(a,":"),(u||"file"===a)&&s.push("//"),u&&(-1===(h=(u=u.toLowerCase()).indexOf(":"))?s.push(i(u)):s.push(i(u.substr(0,h)),u.substr(h))),l){var d=e._upperCaseDrive.exec(l);d&&(l=d[1]?"/"+d[2].toLowerCase()+l.substr(3):d[2].toLowerCase()+l.substr(2));for(var p=0;;){var h;if(-1===(h=l.indexOf(e._slash,p))){s.push(i(l.substring(p)));break}s.push(i(l.substring(p,h)),e._slash),p=h+1}}return c&&s.push("?",i(c)),f&&s.push("#",i(f)),s.join(e._empty)},e.prototype.toJSON=function(){var e={fsPath:this.fsPath,external:this.toString(),$mid:1};return this.path&&(e.path=this.path),this.scheme&&(e.scheme=this.scheme),this.authority&&(e.authority=this.authority),this.query&&(e.query=this.query),this.fragment&&(e.fragment=this.fragment),e},e.revive=function(t){var r=new e;return r._scheme=t.scheme||e._empty,r._authority=t.authority||e._empty,r._path=t.path||e._empty,r._query=t.query||e._empty,r._fragment=t.fragment||e._empty,r._fsPath=t.fsPath,r._formatted=t.external,e._validate(r),r},e}();if(s._empty="",s._slash="/",s._regexp=/^(([^:/?#]+?):)?(\/\/([^/?#]*))?([^?#]*)(\?([^#]*))?(#(.*))?/,s._driveLetterPath=/^\/[a-zA-z]:/,s._upperCaseDrive=/^(\/)?([A-Z]:)/,s._schemePattern=/^\w[\w\d+.-]*$/,s._singleSlashStart=/^\//,s._doubleSlashStart=/^\/\//,t.default=s,"object"==typeof process)i="win32"===process.platform;else if("object"==typeof navigator){var a=navigator.userAgent;i=a.indexOf("Windows")>=0}}(0,X.exports))&&(V.exports=G);for(var Z={},K={quote:function(e){return e.map((function(e){return e&&"object"==typeof e?e.op.replace(/(.)/g,"\\$1"):/["\s]/.test(e)&&!/'/.test(e)?"'"+e.replace(/(['\\])/g,"\\$1")+"'":/["'\s]/.test(e)?'"'+e.replace(/(["\\$`!])/g,"\\$1")+'"':String(e).replace(/([#!"$&'()*,:;<=>?@\[\\\]^`{|}])/g,"\\$1")})).join(" ")}},Q="(?:"+["\\|\\|","\\&\\&",";;","\\|\\&","[&;()|<>]"].join("|")+")",Y="(\\\\['\"|&;()<> \\t]|[^\\s'\"|&;()<> \\t])+",ee="",te=0;te<4;te++)ee+=(Math.pow(16,8)*Math.random()).toString(16);K.parse=function(e,t,r){var n=function(e,t,r){var n=new RegExp(["("+Q+")","("+Y+"|\"((\\\\\"|[^\"])*?)\"|'((\\\\'|[^'])*?)')*"].join("|"),"g"),o=e.match(n).filter(Boolean),i=!1;if(!o)return[];t||(t={});r||(r={});return o.map((function(e,t){if(!i){if("#"===e.charAt(0))return i=!0,{comment:e.substr(1)+o.slice(t+1).join(" ")};if(RegExp("^"+Q+"$").test(e))return{op:e};for(var n="'",a='"',u="$",l=r.escape||"\\",c=!1,f=!1,d="",p=!1,h=0,m=e.length;h<m;h++){var g=e.charAt(h);if(p=p||!c&&("*"===g||"?"===g),f)d+=g,f=!1;else if(c)g===c?c=!1:c==n?d+=g:g===l?(h+=1,d+=(g=e.charAt(h))===a||g===l||g===u?g:l+g):d+=g===u?v():g;else if(g===a||g===n)c=g;else{if(RegExp("^"+Q+"$").test(g))return{op:e};g===l?f=!0:d+=g===u?v():g}}return p?{op:"glob",pattern:d}:d}function v(){var t,r;if(h+=1,"{"===e.charAt(h)){if(h+=1,"}"===e.charAt(h))throw new Error("Bad substitution: "+e.substr(h-2,3));if((t=e.indexOf("}",h))<0)throw new Error("Bad substitution: "+e.substr(h));r=e.substr(h,t-h),h=t}else/[*@#?$!_\-]/.test(e.charAt(h))?(r=e.charAt(h),h+=1):(t=e.substr(h).match(/[^\w\d_]/))?(r=e.substr(h,t.index),h+=t.index-1):(r=e.substr(h),h=e.length);return s(null,"",r)}})).reduce((function(e,t){return void 0===t?e:e.concat(t)}),[]);function s(e,r,n){var o="function"==typeof t?t(n):t[n];return void 0===o&&(o=""),"object"==typeof o?r+ee+JSON.stringify(o)+ee:r+o}}(e,t,r);return"function"!=typeof t?n:n.reduce((function(e,t){if("object"==typeof t)return e.concat(t);var r=t.split(RegExp("("+ee+".*?"+ee+")","g"));return 1===r.length?e.concat(r[0]):e.concat(r.filter(Boolean).map((function(e){return RegExp("^"+ee).test(e)?JSON.parse(e.split(ee)[1]):e})))}),[])},Object.defineProperty(Z,"__esModule",{value:!0}),Z.stringifyError=function(e){return`name: ${e.name}, message: ${e.message}, stack: ${e.stack}.`},Z.maybeToString=function(e){return String(e)},Z.relativeDate=function(e,t,r=!1,n=!1){let o=e,i=t;o instanceof Date&&(o=o.getTime());i||(i=(new Date).getTime());i instanceof Date&&(i=i.getTime());const s=i-o,a=r?le:n?fe:ce;for(const[e,t,n]of a)if(s<e)return"number"==typeof n?Math.round(s/n)+(r?"":" ")+t:t;throw new Error("This should never be reached.")},Z.countOccurrences=function(e,t){(0,re.default)(1===t.length,"char must be a string of length 1");let r=0;const n=t.charCodeAt(0);for(let t=0;t<e.length;t++)e.charCodeAt(t)===n&&r++;return r},Z.shellParse=function(e,t){const r=(0,ne.parse)(e,t);for(let e=0;e<r.length;e++)if("string"!=typeof r[e])throw null!=r[e].op?new Error(`Unexpected operator "${r[e].op}" provided to shellParse`):new Error(`Unexpected comment "${r[e].comment}" provided to shellParse`);return r},Z.shellParseWithGlobs=function(e,t){const r=(0,ne.parse)(e,t);for(let e=0;e<r.length;e++)if("string"!=typeof r[e]){if("glob"!==r[e].op)throw null!=r[e].op?new Error(`Unexpected operator "${r[e].op}" provided to shellParse`):new Error(`Unexpected comment "${r[e].comment}" provided to shellParse`);r[e]=r[e].pattern}return r},Z.shellQuote=function(e){return(0,ne.quote)(e)},Z.removeCommonPrefix=function(e,t){let r=0;for(;e[r]===t[r]&&r<e.length&&r<t.length;)r++;return[e.substring(r),t.substring(r)]},Z.removeCommonSuffix=function(e,t){let r=0;for(;e[e.length-1-r]===t[t.length-1-r]&&r<e.length&&r<t.length;)r++;return[e.substring(0,e.length-r),t.substring(0,t.length-r)]},Z.shorten=function(e,t,r){return e.length<t?e:e.slice(0,t)+(r||"")},Z.splitOnce=function(e,t){const r=e.indexOf(t);return-1===r?[e,null]:[e.slice(0,r),e.slice(r+t.length)]},Z.indent=function(e,t=2,r=" "){return e.replace(/^([^\n])/gm,r.repeat(t)+"$1")},Z.pluralize=function(e,t){return 1===t?e:e+"s"},Z.capitalize=function(e){return 0===e.length?e:e.charAt(0).toUpperCase().concat(e.slice(1))},Z.getMatchRanges=function(e,t){if(""===t)return[];const r=[];let n=0;for(;-1!==(n=e.indexOf(t,n));){const e=r[r.length-1];null!=e&&e[1]===n?e[1]+=t.length:r.push([n,n+t.length]),n+=t.length}return r},Z.escapeMarkdown=function(e){return e.replace(/[#!()*+\-.[\\\]_`{}]/g,"\\$&").replace(/</g,"&lt;").replace(/>/g,"&gt;")},Z.ZERO_WIDTH_SPACE=Z.ELLIPSIS_CHAR=Z.URL_REGEX=void 0;var re=function(e){return e&&e.__esModule?e:{default:e}}(l.default),ne=K;const oe=36e5,ie=24*oe,se=7*ie,ae=365*ie,ue=ae/12,le=[[42e3,"now"],[9e4,"1m"],[36e5,"m",6e4],[54e5,"1h"],[ie,"h",oe],[2*ie,"1d"],[7*ie,"d",ie],[1.5*se,"1w"],[ue,"w",se],[1.5*ue,"1mo"],[ae,"mo",ue],[1.5*ae,"1y"],[Number.MAX_VALUE,"y",ae]],ce=[[42e3,"just now"],[9e4,"a minute ago"],[36e5,"minutes ago",6e4],[54e5,"an hour ago"],[ie,"hours ago",oe],[2*ie,"yesterday"],[7*ie,"days ago",ie],[1.5*se,"a week ago"],[ue,"weeks ago",se],[1.5*ue,"a month ago"],[ae,"months ago",ue],[1.5*ae,"a year ago"],[Number.MAX_VALUE,"years ago",ae]],fe=[[42e3,"just now"],[9e4,"1 minute ago"],[36e5,"minutes ago",6e4],[54e5,"1 hour ago"],[ie,"hours ago",oe],[2*ie,"yesterday"],[7*ie,"days ago",ie],[1.5*se,"1 week ago"],[ue,"weeks ago",se],[1.5*ue,"1 month ago"],[ae,"months ago",ue],[1.5*ae,"1 year ago"],[Number.MAX_VALUE,"years ago",ae]];Z.URL_REGEX=/(https?:\/\/(?:www\.)?[-\w@:%.+~#=]{2,256}\.[a-z]{2,6}\b[-\w@:%+.~#?&/=!]*|www\.[-\w@:%.+~#=]{2,256}\.[a-z]{2,6}\b[-\w@:%+.~#?&/=!]*)/;Z.ELLIPSIS_CHAR="…";Z.ZERO_WIDTH_SPACE="​",Object.defineProperty(J,"__esModule",{value:!0}),J.__TEST__=Qe=J.default=void 0;var de=ve(X.exports),pe=ve(l.default),he=ve(f.default),me=ve(d.default),ge=Z;function ve(e){return e&&e.__esModule?e:{default:e}}const ye=[],_e=/^[A-Za-z0-9_-]+:\/\/.*/;function we(e){return e.startsWith("nuclide://")}function be(e){return e.startsWith("atom://")}function Pe(e,t){return(0,pe.default)(null!=t&&""!==t,"NuclideUri must include a path."),`nuclide://${e}${t}`}function xe(e){if(e.startsWith("nuclide://")){const t=e.substr("nuclide://".length),r=t.indexOf("/");(0,pe.default)(-1!==r,`Remote URIs must contain a hostname and a path. Failed to parse ${e}`);const n=t.substr(0,r);(0,pe.default)(""!==n,`Remote URIs must contain a hostname. Failed to parse ${e}`);const o=t.substr(r);return(0,pe.default)(!Ge(e),`Path cannot end with archive separator. Failed to parse ${e}`),{hostname:n,path:o}}return(0,pe.default)(!Ge(e),`Path cannot end with archive separator. Failed to parse ${e}`),{hostname:null,path:e}}function Ee(e){if(!we(e))throw new Error("Expected remote uri. Got "+e);const t=xe(e);return(0,pe.default)(t.hostname,`Remote Nuclide URIs must contain hostnames, '${(0,ge.maybeToString)(t.hostname)}' found while parsing '${e}'`),{hostname:t.hostname,path:t.path}}function Te(e){return xe(e).path}function Se(e){return Ee(e).hostname}function Oe(e,...t){return Ce(e,t)}function Ce(e,t){Xe(e);const r=qe(e);if(we(e)){const{hostname:n,path:o}=Ee(e);return t.splice(0,0,o),Ne(r,t),ze(r,Pe(n,r.join.apply(null,t)))}return t.splice(0,0,e),Ne(r,t),ze(r,r.join.apply(null,t))}function Re(e){Xe(e);const t=qe(e);if(we(e)){const{hostname:r,path:n}=Ee(e);return Pe(r,ze(t,t.normalize(He(t,n))))}return ze(t,t.normalize(He(t,e)))}function Ae(e,t=""){Xe(e);const r=qe(e);return ze(r,r.basename(He(r,Te(e)),t))}function Ue(e){Xe(e);const t=qe(e);if(we(e)){const{hostname:r,path:n}=Ee(e);return Pe(r,ze(t,t.dirname(He(t,n))))}return ze(t,t.dirname(He(t,e)))}function $e(e){Xe(e);const t=qe(e);return ze(t,t.extname(He(t,Te(e))))}function Ie(e){const t="file://";if(!e.startsWith(t))return null;const r=e.substr(t.length);return function(e){return qe(e)===he.default.win32}(r)?r:null}function je(e,t){if(Xe(e),Xe(t),t.length<e.length)return!(t.length<e.length-1)&&(e.startsWith(t)&&(ke(e)||Je(t,e.length)));if(!t.startsWith(e))return!1;if(ke(e)||e.length===t.length)return!0;const r=qe(t);return Je(t,e.length)||t.slice(e.length).startsWith(r.sep)}const Fe=[];function Le(e){return Fe.reduce(((e,t)=>{const r=t(e);return null!=r&&""!==r?r:e}),e)}function Be(e){return Xe(e),we(e)?Le(Se(e)):e}function De(e){Xe(e);const t=qe(e);return e.endsWith(t.sep)?e:e+t.sep}function ke(e){Xe(e);const t=qe(e);return e.endsWith(t.sep)}function We(e){if(Xe(e),we(e))return!0;return qe(e).isAbsolute(e)}function Me(e){return Xe(e),Ue(e)===e}function qe(e){return(0,pe.default)(!Ge(e),`Path cannot end with archive separator. Failed to determine path module for ${e}`),e.startsWith(he.default.posix.sep)||e.indexOf("://")>-1?he.default.posix:":"===e[1]&&e[2]===he.default.win32.sep||e.split(he.default.win32.sep).length>e.split(he.default.posix.sep).length?he.default.win32:he.default.posix}function Ne(e,t){return t.forEach(((t,r,n)=>n[r]=He(e,t))),t}function He(e,t){return t.indexOf("!")<0?t:ye.reduce(((t,r)=>t.replace(`${r}!`,`${r}!${e.sep}`)),t)}function ze(e,t){return t.indexOf("!")<0?t:Ge(r=ye.reduce(((t,r)=>t.replace(`${r}!${e.sep}`,`${r}!`)),t))?r.substring(0,r.length-"!".length):r;var r}function Ve(e,t){return e.length<t.length&&t.startsWith(e)&&Je(t,e.length)?e+"!":e}function Ge(e){return Je(e,e.length-1)}function Je(e,t){return e.length>t&&"!"===e.charAt(t)&&ye.some((r=>{const n=t-r.length;return e.indexOf(r,n)===n}))}function Xe(e){if(null!=e&&Ge(e))throw new Error(`Path operation invoked on URI ending with !: ${e}`)}const Ze=new Set([".bmp",".gif",".ico",".jpeg",".jpg",".png",".webp"]);var Ke={basename:Ae,dirname:Ue,extname:$e,stripExtension:function(e){Xe(e);const t=$e(e);return 0===t.length?e:e.slice(0,-1*t.length)},isRemote:we,isLocal:function(e){return!we(e)&&!function(e){return _e.test(e)}(e)&&!be(e)},createRemoteUri:Pe,isInArchive:function(e){if(be(e)||e.indexOf("!")<0)return!1;for(let t=e.indexOf("!");t>=0;t=e.indexOf("!",t+1))if(Je(e,t))return!0;return!1},ancestorOutsideArchive:function(e){for(let t=e.indexOf("!");t>=0;t=e.indexOf("!",t+1))if(Je(e,t))return e.substring(0,t);return e},parse:xe,parseRemoteUri:Ee,validate:function(e,t){(0,pe.default)(null!=e,"Unexpected null NuclideUri"),(0,pe.default)("string"==typeof e,`Unexpected NuclideUri type: ${String(e)}`),we(e)?(xe(e),(0,pe.default)(!1!==t,"Expected remote NuclideUri")):((0,pe.default)(""!==e,"NuclideUri must contain a non-empty path"),(0,pe.default)(!0!==t,"Expected local NuclideUri"))},getPath:Te,getHostname:Se,getHostnameOpt:function(e){return null!=e&&we(e)?Se(e):null},join:Oe,joinArray:Ce,archiveJoin:function(e,t){if(Xe(e),!ye.some((t=>e.endsWith(t))))throw new Error(`Cannot archiveJoin with non-archive ${e} and ${t}`);return e+"!"+t},relative:function(e,t){Xe(e);const r=qe(e),n=we(e);if(n!==we(t)||n&&Se(e)!==Se(t))throw new Error(`Cannot relative urls on different hosts: ${e} and ${t}`);const o=He(r,n?Te(e):e),i=He(r,n?Te(t):t);return ze(r,r.relative(Ve(o,i),Ve(i,o)))},looksLikeImageUri:function(e){const t=$e(e).toLowerCase();return Ze.has(t)},normalize:Re,normalizeDir:function(e){return De(Re(e))},getParent:function(e){return Re(Oe(e,".."))},uriToNuclideUri:function(e){const t=Ie(e);if(null!=t)return t;const r=de.default.parse(e);return"file"===r.scheme&&r.path?r.fsPath:we(e)?e:null},nuclideUriToUri:function(e){return Xe(e),we(e)?e:de.default.file(e).toString()},contains:je,collapse:function(e){return e.filter((t=>!e.some((e=>je(e,t)&&e!==t))))},nuclideUriToDisplayString:function(e){return Xe(e),we(e)?`${Be(e)}:${Te(e)}`:e},nuclideUriToDisplayHostname:Be,hostnameToDisplayHostname:Le,registerHostnameFormatter:function(e){return Fe.push(e),{dispose:()=>{const t=Fe.indexOf(e);t>=0&&Fe.splice(t,1)}}},ensureTrailingSeparator:De,trimTrailingSeparator:function(e){Xe(e);const t=qe(e);let r=e;for(;r.endsWith(t.sep)&&!Me(r);)r=r.slice(0,-1*t.sep.length);return r},endsWithSeparator:ke,endsWithEdenDir:function(e){return Xe(e),e.endsWith(".eden")},isAbsolute:We,isHomeRelative:function(e){return Xe(e),e.startsWith("~")},resolve:function(e,...t){Xe(e);const r=qe(e);if(we(e)){const{hostname:n,path:o}=Ee(e);return t.splice(0,0,o),Ne(r,t),Pe(n,ze(r,r.resolve.apply(null,t)))}return t.splice(0,0,e),Ne(r,t),ze(r,r.resolve.apply(null,t))},expandHomeDir:function(e){if(Xe(e),!e.startsWith("~"))return e;const{HOME:t,UserProfile:r}=process.env,n=!we(e)&&"win32"===me.default.platform(),o=n?r:t;return(0,pe.default)(null!=o),"~"===e?o:e.startsWith("~/")||n&&e.startsWith("~\\")?he.default.resolve(o,e.replace("~",".")):e},splitPathList:function(e){(0,pe.default)(e.indexOf("nuclide://")<0,"Splitting remote URIs is not supported");const t=qe(e);return e.split(t.delimiter)},joinPathList:function(e){if(0===e.length)return"";(0,pe.default)(e.every((e=>!we(e))),"Joining of remote URIs is not supported");const t=qe(e[0]);return e.join(t.delimiter)},ensureLocalPrefix:function(e){Xe(e);const t=qe(e);(0,pe.default)(!we(e),"Local prefix can not be added to a remote path"),(0,pe.default)(!We(e),"Local prefix can not be added to an absolute path");const r=`.${t.sep}`;return e.startsWith(r)?e:r+e},isRoot:Me,parsePath:function(e){Xe(e);const t=qe(e),r=t.parse(He(t,Te(e)));return{root:ze(t,r.root),dir:ze(t,r.dir),base:ze(t,r.base),ext:ze(t,r.ext),name:ze(t,r.name)}},split:function(e){const t=[];let r=e,n=Ue(r);for(;r!==n;)t.push(Ae(r)),r=n,n=Ue(r);return We(e)&&t.push(n),t.reverse(),t},pathSeparatorFor:function(e){return qe(e).sep},hasKnownArchiveExtension:function(e){return ye.some((t=>e.endsWith(t)))},ARCHIVE_SEPARATOR:"!",KNOWN_ARCHIVE_EXTENSIONS:ye,NUCLIDE_URI_TYPE_NAME:"NuclideUri"},Qe=J.default=Ke;const Ye={_pathModuleFor:qe};J.__TEST__=Ye;class et{constructor(){this._subscriptions=new e.CompositeDisposable(atom.commands.add("atom-text-editor","code-format:format-code",(async e=>{const t=e.currentTarget.getModel(),r=await this._formatCodeInTextEditor(t);try{if(!B(t.getBuffer(),r))throw new Error("No code formatting providers found!")}catch(e){atom.notifications.addError(`Failed to format code: ${e.message}`,{detail:e.detail})}})),atom.workspace.observeTextEditors((r=>{const n=new e.CompositeDisposable(r.getBuffer().onDidStopChanging((async e=>{if(atom.config.get("atom-ide-code-format.formatOnType"))try{await this._formatCodeOnTypeInTextEditor(r,e)}catch(e){t.getLogger("code-format").warn("Failed to format code on type:",e)}})),r.onDidSave(function(e,t){let r;return(...n)=>{void 0!==r&&clearTimeout(r),r=setTimeout((()=>{e(...n)}),t)}}((async()=>{const e=await this._formatCodeOnSaveInTextEditor(r);if(!B(r.getBuffer(),e))throw new Error("No code formatting providers found!")}),500)));r.onDidDestroy((()=>n.dispose()))}))),this._rangeProviders=new h,this._fileProviders=new h,this._onTypeProviders=new h,this._onSaveProviders=new h}async _formatCodeInTextEditor(t,r=t.getSelectedBufferRange()){const n=t.getBuffer().getRange();let o;if(r.isEmpty())o=n;else{const{start:t,end:n}=r;o=new e.Range([t.row,0],0===n.column?n:[n.row+1,0])}const i=[...this._rangeProviders.getAllProvidersForEditor(t)],s=(await this._reportBusy(t,Promise.all(i.map((e=>e.formatCode(t,o)))))).filter((e=>e.length>0)),a=[...this._fileProviders.getAllProvidersForEditor(t)],u=(await this._reportBusy(t,Promise.all(a.map((e=>e.formatEntireFile(t,o)))))).filter((e=>null!=e)),l=t.getText(),c=t.getBuffer().getRange(),f=u.map((({formatted:e})=>[{oldRange:c,newText:e,oldText:l}]));return(o.isEqual(n)?f.concat(s):s.concat(f)).flat()}async _formatCodeOnTypeInTextEditor(e,{changes:t}){if(1!==t.length)return[];const r=[...this._onTypeProviders.getAllProvidersForEditor(e)];if(0===r.length)return[];const n=t[0];if(!function(e){if(""!==e.oldText)return!1;if(""===e.newText)return!1;if(e.newText.length>1&&!function(e){if(void 0===atom.packages.getActivePackage("bracket-matcher"))return!1;return atom.config.get("bracket-matcher.autocompleteCharacters").includes(e)}(e.newText))return!1;return!0}(n))return[];const o=n.newText[n.newText.length-1],i=e.getText(),s=e.getCursorBufferPosition().copy(),a=await Promise.all(r.map((t=>t.formatAtPosition(e,e.getCursorBufferPosition(),o)))),u=a.findIndex((e=>e.length>0));if(-1===u)return[];{const t=a[u],n=r[u];if(function(e,t){if(e!==t)throw new Error("The file contents were changed before formatting was complete.")}(i,e.getText()),!B(e.getBuffer(),t))throw new Error("Could not apply edits to text buffer.");return n.keepCursorPosition&&e.setCursorBufferPosition(s),t}}async _formatCodeOnSaveInTextEditor(e){const t=[...this._onSaveProviders.getAllProvidersForEditor(e)];if(t.length>0){return(await this._reportBusy(e,Promise.all(t.map((t=>t.formatOnSave(e)))),!1)).filter((e=>e.length>0)).flat()}return function(e){return atom.config.get("atom-ide-code-format.formatOnSave",{scope:e.getRootScopeDescriptor()})}(e)?this._formatCodeInTextEditor(e,e.getBuffer().getRange()):[]}_reportBusy(e,t,r=!0){const n=this._busySignalService;if(void 0!==n){const o=e.getPath(),i=void 0!==o?Qe.basename(o):"<untitled>";return n.reportBusyWhile(`Formatting code in ${i}`,(()=>t),{revealTooltip:r})}return t}addRangeProvider(e){return this._rangeProviders.addProvider(e)}addFileProvider(e){return this._fileProviders.addProvider(e)}addOnTypeProvider(e){return this._onTypeProviders.addProvider(e)}addOnSaveProvider(e){return this._onSaveProviders.addProvider(e)}consumeBusySignal(t){return this._busySignalService=t,new e.Disposable((()=>{this._busySignalService=void 0}))}dispose(){this._subscriptions.dispose()}}var tt={formatOnSave:{title:"Format on Save",type:"boolean",default:!0,description:"Automatically format code upon saving for supported languages."},formatOnType:{title:"Format on Type",type:"boolean",default:!1,description:"Automatically format code as you type it for supported languages."}};let rt;function nt(e){return rt.addRangeProvider(e)}function ot(e){return rt.addFileProvider(e)}function it(e){return rt.addOnTypeProvider(e)}function st(e){return rt.addOnSaveProvider(e)}exports.activate=function(){rt=new et},exports.config=tt,exports.consumeBusySignal=function(e){return rt.consumeBusySignal(e)},exports.consumeFileProvider=ot,exports.consumeLegacyProvider=function(e){if(e.grammarScopes=e.grammarScopes||(null!=e.selector?e.selector.split(", "):null),e.priority=null!=e.priority?e.priority:null!=e.inclusionPriority?e.inclusionPriority:0,"formatCode"in e)return nt(e);if("formatEntireFile"in e)return ot(e);if("formatAtPosition"in e)return it(e);if("formatOnSave"in e)return st(e);throw new Error("Invalid code format provider")},exports.consumeOnSaveProvider=st,exports.consumeOnTypeProvider=it,exports.consumeRangeProvider=nt,exports.deactivate=function(){rt.dispose()};
//# sourceMappingURL=main.js.map
